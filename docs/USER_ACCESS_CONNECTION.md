# Связь между AmneziaWG Web UI и списком пользователей

## Общая архитектура

В VPN-сервисе на базе AmneziaWG существует четкое разделение между:

1. **AmneziaWG Web UI** - отвечает за управление VPN-клиентами и генерацию конфигураций
2. **Система управления пользователями** - отвечает за учет пользователей, подписок и платежей
3. **Интеграция** - обеспечивает связь между этими двумя системами

## Как работает связь

### 1. Создание клиента в AmneziaWG

Когда пользователь оплачивает подписку:

1. В системе управления пользователями создается запись о платеже
2. При первом запросе VPN-конфига (через Telegram-бота или webhook):
   - Вызывается API AmneziaWG для создания нового клиента
   - Генерируется уникальное имя клиента (например, `tg_123456789_payment123`)
   - AmneziaWG автоматически назначает IP-адрес и генерирует ключи
   - Получается конфигурационный файл
   - Конфиг отправляется пользователю и сохраняется в базе данных

### 2. Идентификация пользователей

- Каждый VPN-клиент в AmneziaWG связан с Telegram ID пользователя
- Имя клиента в AmneziaWG содержит Telegram ID и ID платежа
- Это позволяет точно определить, какому пользователю принадлежит тот или иной VPN-клиент

### 3. Управление доступом

- Система управления пользователями отслеживает статус подписки
- При истечении подписки можно отключить соответствующего клиента в AmneziaWG
- При продлении подписки клиент снова включается

## API-вызовы

### Создание клиента
```
POST /api/wireguard/client
{
  "name": "tg_123456789_payment123"
}
```

### Получение конфигурации
```
GET /api/wireguard/client/{client_id}/configuration
```

### Управление клиентом
```
PUT /api/wireguard/client/{client_id}/enable    # Включить
PUT /api/wireguard/client/{client_id}/disable   # Отключить
DELETE /api/wireguard/client/{client_id}        # Удалить
```

## Безопасность

- Только авторизованные администраторы имеют доступ к AmneziaWG Web UI
- Создание клиентов происходит автоматически через API
- Клиенты не могут самостоятельно регистрироваться в AmneziaWG
- Доступ к VPN-конфигурациям ограничен системой аутентификации в Telegram-боте

## Преимущества такой архитектуры

1. **Централизованное управление** - все пользователи и подписки в одной системе
2. **Автоматизация** - новые клиенты создаются автоматически при оплате
3. **Безопасность** - разделение ответственности между системами
4. **Масштабируемость** - легко добавлять новые функции и интеграции
5. **Аудит** - полная история всех действий с VPN-клиентами

## Возможные проблемы и решения

### Проблема: Максимальное количество клиентов
**Решение**: Регулярная очистка неактивных клиентов через скрипты

### Проблема: Синхронизация статусов
**Решение**: Регулярная проверка статусов подписок и обновление состояния клиентов в AmneziaWG

### Проблема: Ошибки API
**Решение**: Повторные попытки и логирование ошибок для ручного вмешательства