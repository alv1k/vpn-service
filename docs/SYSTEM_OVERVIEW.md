# Документация по VPN-сервису на базе AmneziaWG

## Структура проекта

- `api/` - API-сервер для обработки webhook от YooKassa и интеграции с AmneziaWG
- `bot/` - Telegram-бот для взаимодействия с пользователями
- `docker-config/` - конфигурационные файлы для Docker
- `scripts/` - служебные скрипты для установки, резервного копирования и тестирования
- `docs/` - документация

## Архитектура системы

### Основные компоненты

1. **AmneziaWG** - VPN-сервер на базе WireGuard с веб-интерфейсом
2. **Telegram-бот** - интерфейс для пользователей
3. **YooKassa** - платежная система
4. **MySQL** - база данных для хранения информации о пользователях и платежах
5. **Redis** - кэширование и хранение временных данных

### Процесс работы

1. Пользователь оформляет подписку через Telegram-бота
2. Бот создает платеж в YooKassa
3. При успешной оплате YooKassa отправляет webhook
4. API-сервер обрабатывает webhook и создает VPN-клиента в AmneziaWG
5. Конфигурация отправляется пользователю через Telegram

## Интеграция с AmneziaWG

### API-вызовы

- Авторизация: `POST /api/session`
- Создание клиента: `POST /api/wireguard/client`
- Получение конфигурации: `GET /api/wireguard/client/{id}/configuration`
- Управление клиентом: `PUT/DELETE /api/wireguard/client/{id}`

### Связь с пользователями

- Каждый VPN-клиент связан с Telegram ID пользователя
- Имя клиента содержит информацию о пользователе и платеже
- Статус подписки синхронизируется с состоянием клиента в AmneziaWG

## Тестирование API

Для проверки работы API AmneziaWG используйте скрипты в директории `scripts/`:

- `simple_test_api.sh` - простой тест API
- `test_amneziawg_api.ps1` - PowerShell скрипт для Windows
- `amneziawg_curl_commands.sh` - bash скрипт с curl командами

## Управление пользователями

Система управления пользователями включает:

- Регистрацию пользователей через Telegram ID
- Управление подписками и тарифами
- Обработку платежей и webhook от YooKassa
- Создание и удаление VPN-клиентов
- Отслеживание статуса подписок

## Безопасность

- Все API-вызовы защищены аутентификацией
- Проверка IP-адресов webhook от YooKassa
- Ограничение доступа к веб-интерфейсу AmneziaWG
- Шифрование конфиденциальных данных

## Мониторинг и логирование

- Все операции логируются с подробной информацией
- Статусы платежей и подписок отслеживаются в базе данных
- Ошибки обрабатываются и логируются для диагностики

## Резервное копирование

Скрипты резервного копирования обеспечивают:

- Регулярное резервное копирование базы данных
- Архивацию конфигураций VPN-клиентов
- Хранение резервных копий с ограничением по времени